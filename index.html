<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RaceBox PRO — Fixed Full</title>
<style>
/* RaceBox PRO — Full UI (dark neon) - fixed */
:root{
  --bg:#04050a;
  --card:#0f1720;
  --glass: rgba(255,255,255,0.03);
  --muted:#98a4b3;
  --neon:#ff3b30;
  --neon-2:#ff6b55;
  --accent:#64d2ff;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color-scheme: dark;
}
*{box-sizing:border-box;-webkit-tap-highlight-color: transparent}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#02040a 0%, #071026 100%);color:#e6eef6}
.container{max-width:1100px;margin:14px auto;padding:14px;border-radius:14px}

/* header */
.header{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 24px rgba(0,0,0,0.6)}
.brand{font-weight:900;color:var(--neon);font-size:20px}
.subtitle{color:var(--muted);font-size:13px;margin-left:auto}

/* controls */
.controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#dfeafe;cursor:pointer;font-weight:700}
.btn.arm{background:linear-gradient(90deg,var(--neon),var(--neon-2));border:none;color:#fff}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
.btn.stop{background:#222;border:1px solid rgba(255,255,255,0.03)}
.control-right{margin-left:auto;display:flex;gap:10px;align-items:center}

/* status */
.status{display:flex;gap:18px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));border:1px solid rgba(255,255,255,0.02)}
.block{display:flex;flex-direction:column}
.label{font-size:12px;color:var(--muted)}
.big{font-size:50px;font-weight:900;color:#fff}
.small{font-size:14px;color:#cfe6ff}

/* layout */
.main{display:grid;grid-template-columns:1fr 420px;gap:14px;margin-top:12px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.left{display:flex;flex-direction:column;gap:12px;align-items:center}
.right{display:flex;flex-direction:column;gap:12px}

/* top info row */
.top-info{width:100%;display:flex;gap:12px;justify-content:space-between;align-items:center}
.badge{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-weight:700}

/* info row */
.info-row{display:flex;gap:12px;width:100%;justify-content:space-between}
.info-item{text-align:center}
.info-item .val{font-weight:900;font-size:20px;color:#fff}
.info-item .muted{font-size:12px;color:var(--muted)}

/* milestones */
.milestones{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.milestone{background:var(--card);padding:12px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.02)}
.milestone .dist{font-size:16px;font-weight:900;color:var(--accent)}
.milestone .time{margin-top:6px;font-weight:800;font-size:16px;color:#fff}
.milestone .speed{font-size:12px;color:var(--muted)}

/* graph */
.graph{width:100%;height:150px;border-radius:8px;background:linear-gradient(180deg,#071226,#04101a);display:flex;align-items:center;justify-content:center;color:#7fbfe8;border:1px solid rgba(255,255,255,0.02)}
canvas{border-radius:8px}

/* dyno / estimate box */
.box{background:#071021;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input[type="number"], select { background:transparent; border:1px solid rgba(255,255,255,0.04); padding:8px; border-radius:8px; color:#dfeafe}
label{color:var(--muted);font-size:13px}

/* history */
.history{max-height:260px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left}
th{color:var(--muted);font-weight:700;font-size:12px}

/* note */
.note{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}

/* responsive */
@media(max-width:980px){
  .main{grid-template-columns:1fr}
  .big{font-size:40px}
  .brand{font-size:18px}
}
@media(max-width:520px){
  .big{font-size:34px}
  .info-item .val{font-size:16px}
  .controls{gap:6px}
  .btn{padding:8px 10px}
}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">RaceBox PRO</div>
      <div class="subtitle">Drag Timer — 20 / 100 / 201 / 402 — Fixed</div>
    </div>

    <div class="controls">
      <button id="armBtn" class="btn arm">ARM</button>
      <button id="stopBtn" class="btn stop">STOP</button>
      <button id="resetBtn" class="btn ghost">RESET</button>
      <button id="saveBtn" class="btn">SAVE RUN</button>
      <button id="exportBtn" class="btn">EXPORT CSV</button>

      <div class="control-right">
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted)">
          <input id="rollout" type="checkbox" /> 1 ft rollout
        </label>
      </div>
    </div>

    <div class="status card">
      <div style="display:flex;gap:24px;align-items:center;flex-wrap:wrap">
        <div class="block">
          <div class="label">Status</div>
          <div id="status" class="big">idle</div>
        </div>

        <div class="block">
          <div class="label">Speed</div>
          <div id="speedDisplay" class="big">0.0 km/h</div>
        </div>

        <div class="block">
          <div class="label">Distance</div>
          <div id="distance" class="big">0.00 m</div>
        </div>

        <div class="block">
          <div class="label">Time</div>
          <div id="time" class="big">0.000 s</div>
        </div>

        <div class="block">
          <div class="label">Avg</div>
          <div id="avg" class="small">—</div>
        </div>

        <div style="margin-left:auto">
          <div class="label">Accuracy</div>
          <div id="accuracy" class="small">— m</div>
        </div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="card left">
        <div class="top-info" style="width:100%">
          <div class="badge">Mode</div>
          <div style="margin-left:8px">
            <select id="modeSelect" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:#dfeafe">
              <option value="402">402 m</option>
              <option value="201">201 m</option>
              <option value="0-100">0-100</option>
              <option value="0-140">0-140</option>
              <option value="60-100">60-100</option>
            </select>
          </div>

          <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
            <div class="badge">Peak</div><div id="peak" style="font-weight:900">— km/h</div>
            <div class="badge">G</div><div id="peakG" style="font-weight:900">—</div>
          </div>
        </div>

        <div class="graph" style="width:100%">
          <canvas id="speedGraph" width="900" height="150" style="width:100%;height:100%"></canvas>
        </div>

        <div class="info-row">
          <div class="info-item">
            <div class="val" id="spk">0.0</div>
            <div class="muted">Current km/h</div>
          </div>
          <div class="info-item">
            <div class="val" id="distk">0.00</div>
            <div class="muted">Meter</div>
          </div>
          <div class="info-item">
            <div class="val" id="timek">0.000</div>
            <div class="muted">Seconds</div>
          </div>
        </div>

        <div style="width:100%;margin-top:6px;display:flex;gap:8px;align-items:center">
          <div style="flex:1" class="box">
            <div style="font-weight:800;margin-bottom:6px">Estimate WHP (from marker)</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label style="font-size:13px;color:var(--muted)">Mass (kg)</label>
              <input id="massInput" type="number" min="40" value="150" style="width:100px">
              <label style="font-size:13px;color:var(--muted)">Use marker</label>
              <select id="estMarker" style="width:120px">
                <option value="20">20 m</option>
                <option value="100">100 m</option>
                <option value="201" selected>201 m</option>
                <option value="402">402 m</option>
              </select>
              <button id="estimateBtn" class="btn" style="padding:8px 10px">Estimate HP</button>
            </div>
            <div style="margin-top:8px;color:var(--muted)" id="estimateResult">—</div>
          </div>

          <div style="width:320px" class="box">
            <div style="font-weight:800;margin-bottom:6px">Dyno Input / Compare</div>
            <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
              <input id="dynoHP" type="number" placeholder="16.8" style="width:100px">
              <input id="dynoHP_RPM" type="number" placeholder="8500" style="width:110px">
              <button id="saveDynoBtn" class="btn" style="padding:8px 10px">Save Dyno</button>
            </div>
            <div style="font-size:13px;color:var(--muted)" id="dynoResult">Dyno not set</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card right">
        <h3 style="margin:0 0 8px">Run Results</h3>
        <div class="milestones" id="runResults">
          <div style="grid-column:1/3;color:var(--muted);text-align:center">No run yet. ARM then gas to start.</div>
        </div>

        <div style="margin-top:12px" class="box">
          <div style="font-weight:800;margin-bottom:8px">History</div>
          <div class="history" style="max-height:200px;overflow:auto">
            <table id="historyTable">
              <thead><tr><th>#</th><th>Mode</th><th>20s</th><th>100s</th><th>201s</th><th>402s</th><th>Peak</th><th>Date</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:12px" class="box">
          <div style="font-weight:800;margin-bottom:8px">Raw (debug)</div>
          <pre id="rawRun" style="height:120px;overflow:auto;margin:0;background:#081226;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)">—</pre>
        </div>
      </div>
    </div>

    <div class="note">Tip: gunakan ponsel GNSS multi-frequency, pasang di bracket; jangan di kantong.</div>
  </div>

<script>
/* RaceBox PRO - Fixed Full script
   - All fixes integrated
   - Lower start threshold, larger accuracy tolerance
   - finished flag, safe clearing, missing-element safe
*/

// Config tuned for real phones
const CONFIG = {
  GHOST_THRESHOLD_KMH: 2.2,
  START_THRESHOLD_KMH: 2.2,
  START_WINDOW_MS: 300,
  SPEED_SMOOTH_ALPHA: 0.25,
  HEADING_MAX_DEG: 45,
  REBUILD_SPEED_MAX_DT: 1200,
  ROLL_OUT_M: 0.3048,
  ACCURACY_ALLOW: 120,
  GRAPH_MAX_POINTS: 240
};

(function(){
  // DOM refs (safe lookups)
  const armBtn = document.getElementById('armBtn');
  const stopBtn = document.getElementById('stopBtn');
  const resetBtn = document.getElementById('resetBtn');
  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const rolloutChk = document.getElementById('rollout');
  const statusBar = document.getElementById('status');
  const speedDisplay = document.getElementById('speedDisplay');
  const distanceEl = document.getElementById('distance');
  const timeEl = document.getElementById('time');
  const avgEl = document.getElementById('avg');
  const accEl = document.getElementById('accuracy');
  const peakEl = document.getElementById('peak');
  const spk = document.getElementById('spk');
  const distk = document.getElementById('distk');
  const timek = document.getElementById('timek');
  const runResults = document.getElementById('runResults');
  const rawRun = document.getElementById('rawRun');
  const historyTableBody = document.querySelector('#historyTable tbody');
  const speedGraph = document.getElementById('speedGraph');
  const ctx = speedGraph ? speedGraph.getContext('2d') : null;
  const modeSelect = document.getElementById('modeSelect');
  const estimateBtn = document.getElementById('estimateBtn');
  const massInput = document.getElementById('massInput');
  const estMarker = document.getElementById('estMarker');
  const estimateResult = document.getElementById('estimateResult');
  const dynoHP = document.getElementById('dynoHP');
  const dynoHP_RPM = document.getElementById('dynoHP_RPM');
  const saveDynoBtn = document.getElementById('saveDynoBtn');
  const dynoResult = document.getElementById('dynoResult');

  // state
  let watchId = null;
  let armed = false;
  let running = false;
  let finished = false;
  let startPos = null;
  let lastPos = null;
  let lastHeading = null;
  let cumulative = 0;
  let startTime = null;
  let peakSpeed = 0;
  let peakG = 0;
  let samples = []; // {t, speed}
  let graphSamples = [];
  let history = JSON.parse(localStorage.getItem('rb_history') || '[]');

  const MILESTONES = [20,100,201,402];
  let marks = {};

  // Kalman-like simple smoothing using low-pass + fallback (kept simple)
  function lowPass(prev, cur, alpha){ return (alpha*cur) + ((1-alpha)*prev); }

  function setStatus(s){ if(statusBar) statusBar.textContent = s; }

  function resetMarks(){ marks = {}; MILESTONES.forEach(m=>marks[m]=null); }

  function resetUI(){
    if(distanceEl) distanceEl.textContent='0.00 m';
    if(timeEl) timeEl.textContent='0.000 s';
    if(speedDisplay) speedDisplay.textContent='0.0 km/h';
    if(avgEl) avgEl.textContent='—';
    if(accEl) accEl.textContent='— m';
    if(spk) spk.textContent='0.0';
    if(distk) distk.textContent='0.00';
    if(timek) timek.textContent='0.000';
    if(runResults) runResults.innerHTML = '<div style="grid-column:1/3;color:var(--muted);text-align:center">No run yet. ARM then gas to start.</div>';
    if(rawRun) rawRun.textContent='—';
    samples = []; graphSamples = []; peakSpeed = 0; peakG = 0;
    if(ctx) ctx.clearRect(0,0,speedGraph.width,speedGraph.height);
  }

  // haversine
  function hav(a,b){ const R=6371000, r=Math.PI/180; const dLat=(b.latitude-a.latitude)*r; const dLon=(b.longitude-a.longitude)*r; const la=a.latitude*r, lb=b.latitude*r; const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2); const h=s1*s1 + Math.cos(la)*Math.cos(lb)*s2*s2; return R*2*Math.atan2(Math.sqrt(h), Math.sqrt(1-h)); }

  function headingDeg(a,b){
    const rad = Math.PI/180;
    const y = Math.sin((b.longitude - a.longitude)*rad) * Math.cos(b.latitude*rad);
    const x = Math.cos(a.latitude*rad)*Math.sin(b.latitude*rad) - Math.sin(a.latitude*rad)*Math.cos(b.latitude*rad)*Math.cos((b.longitude - a.longitude)*rad);
    const brad = Math.atan2(y,x);
    return (brad*180/Math.PI + 360) % 360;
  }

  function clearGraph(){ if(!ctx) return; ctx.clearRect(0,0,speedGraph.width,speedGraph.height); ctx.fillStyle='#071226'; ctx.fillRect(0,0,speedGraph.width,speedGraph.height); }

  function drawGraph(){
    if(!ctx) return;
    clearGraph();
    const pts = graphSamples.slice(-CONFIG.GRAPH_MAX_POINTS);
    if(pts.length===0) return;
    const w = speedGraph.width, h = speedGraph.height;
    const maxSpeed = Math.max(100, ...pts.map(p=>p.speed));
    ctx.lineWidth = 2; ctx.strokeStyle = '#64d2ff'; ctx.beginPath();
    pts.forEach((p,i)=>{
      const x = (i/(pts.length-1))*w;
      const y = h - (p.speed/maxSpeed)*h;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    // vertical line at last milestone if any
    const lastPeak = peakSpeed;
    ctx.setLineDash([6,4]);
    ctx.strokeStyle = 'rgba(255,59,48,0.18)';
    // draw horizontal peak line
    const pkY = h - (lastPeak/maxSpeed)*h;
    ctx.beginPath(); ctx.moveTo(0,pkY); ctx.lineTo(w,pkY); ctx.stroke();
    ctx.setLineDash([]);
  }

  function renderRunResults(){
    if(!runResults || !window._lastRun) return;
    const r = window._lastRun;
    runResults.innerHTML = '';
    for(const m of MILESTONES){
      const mk = r.marks && r.marks[m];
      const div = document.createElement('div'); div.className='milestone';
      const d = document.createElement('div'); d.className='dist'; d.textContent = m + ' m';
      const t = document.createElement('div'); t.className='time'; t.textContent = mk && mk.time ? mk.time.toFixed(2)+' s' : '—';
      const s = document.createElement('div'); s.className='speed'; s.textContent = mk && mk.speed ? mk.speed.toFixed(2)+' km/h' : '—';
      div.appendChild(d); div.appendChild(t); div.appendChild(s);
      runResults.appendChild(div);
    }
    const peakRow = document.createElement('div'); peakRow.style.gridColumn='1/3'; peakRow.style.textAlign='center'; peakRow.style.marginTop='8px';
    peakRow.innerHTML = `<div style="font-weight:800">Peak: ${r.peak?r.peak.toFixed(2)+' km/h':'—'} &nbsp; • &nbsp; Peak G: ${r.peakG?r.peakG.toFixed(2)+' g':'—'}</div>`;
    runResults.appendChild(peakRow);
  }

  function renderHistory(){
    if(!historyTableBody) return;
    historyTableBody.innerHTML = '';
    history.forEach((h,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${h.mode||''}</td><td>${h.d20?h.d20.toFixed(3):''}</td><td>${h.d100?h.d100.toFixed(3):''}</td><td>${h.d201?h.d201.toFixed(3):''}</td><td>${h.d402?h.d402.toFixed(3):''}</td><td>${h.peak?h.peak.toFixed(1):''}</td><td>${new Date(h.date).toLocaleString()}</td>`;
      historyTableBody.appendChild(tr);
    });
  }

  // Estimate WHP (energy based)
  function estimateWHP(massKg, marker){
    if(!window._lastRun || !window._lastRun.marks) return null;
    const mk = window._lastRun.marks[marker];
    if(!mk || !mk.time || !mk.speed) return null;
    const v = mk.speed / 3.6; // m/s
    const t = mk.time;
    if(t <= 0 || v <= 0) return null;
    const energy = 0.5 * massKg * v * v; // J
    const powerW = energy / t;
    const hp = powerW / 745.7;
    return {hp, powerW, v, t};
  }

  // Finish run: safe freeze & cleanup
  function finishRun(){
    if(finished) return;
    finished = true;
    running = false;
    armed = false;
    setStatus('finish — run complete');

    const last = {
      mode: modeSelect ? modeSelect.value : '',
      date: Date.now(),
      peak: peakSpeed,
      peakG: peakG,
      marks: JSON.parse(JSON.stringify(marks)),
      d20: marks[20] ? marks[20].time : null,
      d100: marks[100] ? marks[100].time : null,
      d201: marks[201] ? marks[201].time : null,
      d402: marks[402] ? marks[402].time : null,
      s20: marks[20] ? marks[20].speed : null,
      s100: marks[100] ? marks[100].speed : null,
      s201: marks[201] ? marks[201].speed : null,
      s402: marks[402] ? marks[402].speed : null,
      distance: cumulative,
      rollout: !!(rolloutChk && rolloutChk.checked),
      peakG: peakG
    };
    window._lastRun = last;
    renderRunResults();
    renderHistory();
    if(rawRun) rawRun.textContent = JSON.stringify(last, null, 2);
    // stop GPS updates
    if(watchId){ try{ navigator.geolocation.clearWatch(watchId); }catch(e){}; watchId = null; }
    // clear transient samples to avoid further UI jitter
    samples = []; graphSamples = [];
  }

  // Main GPS handler
  function onPos(p){
    if(!p || !p.coords) return;
    if(finished) return; // ignore after finish

    const c = p.coords;
    if(accEl) accEl.textContent = (c.accuracy||0).toFixed(1) + ' m';

    // measured speed (may be null)
    let measuredKmh = (typeof c.speed === 'number') ? c.speed * 3.6 : null;
    const now = performance.now();

    // compute delta if lastPos exists
    let d = 0;
    if(lastPos && c.latitude && c.longitude){
      const dtmp = hav(lastPos, {latitude: c.latitude, longitude: c.longitude});
      const hNow = lastHeading !== null ? headingDeg(lastPos, {latitude: c.latitude, longitude: c.longitude}) : null;
      let headingOk = true;
      if(lastHeading !== null && hNow !== null){
        const diff = Math.abs(((hNow - lastHeading + 540) % 360) - 180);
        if(diff > CONFIG.HEADING_MAX_DEG) headingOk = false;
      }
      lastHeading = hNow;

      // rebuild speed if measured missing or too small
      const dtMs = samples.length ? now - samples[samples.length-1].t : 0;
      if((measuredKmh === null || measuredKmh < 0.5) && dtMs > 0 && dtMs <= CONFIG.REBUILD_SPEED_MAX_DT && headingOk){
        const rebuilt = (dtmp / (dtMs/1000)) * 3.6; // km/h
        measuredKmh = rebuilt;
      }

      // use delta for distance accumulation only after start
      d = headingOk ? dtmp : 0;
    }

    // ghost filter
    if(measuredKmh !== null && measuredKmh < CONFIG.GHOST_THRESHOLD_KMH) measuredKmh = 0;

    // smoothing (low-pass)
    const lastSpeed = samples.length ? samples[samples.length-1].speed : (measuredKmh || 0);
    const smooth = lowPass(lastSpeed, measuredKmh !== null ? measuredKmh : lastSpeed, CONFIG.SPEED_SMOOTH_ALPHA);

    // push sample (keep window)
    samples.push({t: now, speed: smooth});
    const maxKeep = 3000;
    samples = samples.filter(s => now - s.t <= maxKeep);

    graphSamples.push({t: now, speed: smooth});
    if(graphSamples.length > 2000) graphSamples.shift();

    if(speedDisplay) speedDisplay.textContent = smooth.toFixed(1) + ' km/h';
    if(spk) spk.textContent = smooth.toFixed(1);
    if(measuredKmh !== null && measuredKmh > peakSpeed) peakSpeed = measuredKmh;
    if(peakEl) peakEl.textContent = peakSpeed ? peakSpeed.toFixed(1) + ' km/h' : '—';

    // compute G (rough) using last sample delta
    if(samples.length > 1){
      const prev = samples[samples.length-2];
      const dt = (now - prev.t)/1000;
      if(dt > 0){
        const dv = (smooth - prev.speed)/3.6; // m/s
        const accel = dv / dt;
        const g = accel / 9.80665;
        if(g > peakG) peakG = g;
        const peakGEl = document.getElementById('peakG');
        if(peakGEl) peakGEl.textContent = peakG ? peakG.toFixed(2) + ' g' : '—';
      }
    }

    drawGraph();

    // if not armed, update lastPos only and exit
    if(!armed){
      lastPos = { latitude: c.latitude, longitude: c.longitude };
      return;
    }

    // require reasonable GPS lock before start
    if(!startPos){
      if(c.accuracy <= CONFIG.ACCURACY_ALLOW){
        startPos = { latitude: c.latitude, longitude: c.longitude };
        lastPos = startPos;
        lastHeading = null;
        setStatus('armed — waiting throttle');
      } else {
        setStatus('arming — waiting GPS accuracy');
      }
      lastPos = { latitude: c.latitude, longitude: c.longitude };
      return;
    }

    // START detection: stable >= START_THRESHOLD for window
    const nowMs = performance.now();
    const recent = samples.filter(s => nowMs - s.t <= CONFIG.START_WINDOW_MS);
    const ready = recent.length > 0 && recent.every(s => s.speed >= CONFIG.START_THRESHOLD_KMH);

    if(!running){
      if(ready){
        running = true;
        startTime = now;
        cumulative = 0;
        peakSpeed = smooth;
        samples = [{t: now, speed: smooth}];
        resetMarks();
        setStatus('running');
      } else {
        setStatus('armed — waiting throttle');
      }
      lastPos = { latitude: c.latitude, longitude: c.longitude };
      return;
    }

    // RUNNING: accumulate distance/time
    cumulative += d;
    if(distanceEl) distanceEl.textContent = cumulative.toFixed(2) + ' m';
    if(distk) distk.textContent = cumulative.toFixed(2);

    const elapsed = (now - startTime)/1000;
    if(timeEl) timeEl.textContent = elapsed.toFixed(3) + ' s';
    if(timek) timek.textContent = elapsed.toFixed(3);

    const avg = elapsed > 0 ? (cumulative / elapsed) * 3.6 : 0;
    if(avgEl) avgEl.textContent = avg.toFixed(1) + ' km/h';

    const rolloutOffset = (rolloutChk && rolloutChk.checked) ? CONFIG.ROLL_OUT_M : 0;

    for(const m of MILESTONES){
      if(!marks[m] && cumulative >= (m - rolloutOffset)){
        marks[m] = { time: elapsed, speed: smooth };
        renderRunResults();
      }
    }

    // finish triggers
    if(marks[402]){ finishRun(); lastPos = { latitude: c.latitude, longitude: c.longitude }; return; }

    if(modeSelect){
      const mode = modeSelect.value;
      if(mode === '201' && cumulative >= (201 - rolloutOffset)){ finishRun(); lastPos = { latitude: c.latitude, longitude: c.longitude }; return; }
      if(mode === '402' && cumulative >= (402 - rolloutOffset)){ finishRun(); lastPos = { latitude: c.latitude, longitude: c.longitude }; return; }
      if(mode === '0-100' && peakSpeed >= 100){ finishRun(); lastPos = { latitude: c.latitude, longitude: c.longitude }; return; }
      if(mode === '0-140' && peakSpeed >= 140){ finishRun(); lastPos = { latitude: c.latitude, longitude: c.longitude }; return; }
      if(mode === '60-100'){
        const lastSpeeds = samples.slice(-10).map(s => s.speed);
        if(lastSpeeds.some(s => s >= 60) && lastSpeeds.some(s => s >= 100)){ finishRun(); lastPos = { latitude: c.latitude, longitude: c.longitude }; return; }
      }
    }

    lastPos = { latitude: c.latitude, longitude: c.longitude };
  } // end onPos

  // UI handlers
  function arm(){
    // if already armed, disarm (toggle)
    if(armed){
      armed = false; running = false; finished = false;
      startPos = null; lastPos = null; lastHeading = null;
      cumulative = 0; startTime = null; peakSpeed = 0; peakG = 0; samples = []; graphSamples = [];
      resetMarks();
      if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
      setStatus('idle'); resetUI(); return;
    }
    if(!('geolocation' in navigator)){ alert('Geolocation tidak tersedia'); return; }
    running = false; armed = true; finished = false;
    startPos = null; lastPos = null; lastHeading = null;
    cumulative = 0; startTime = null; peakSpeed = 0; peakG = 0; samples = []; graphSamples = [];
    resetMarks();
    setStatus('arming — requesting GPS');
    if(watchId !== null) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(onPos, e => { setStatus('GPS error: ' + e.message); }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
  }

  function stop(){
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
    running = false; armed = false; finished = false;
    setStatus('stopped');
  }

  function resetAll(){
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
    armed = false; running = false; finished = false;
    startPos = null; lastPos = null; lastHeading = null;
    cumulative = 0; startTime = null; peakSpeed = 0; peakG = 0;
    samples = []; graphSamples = [];
    resetMarks(); resetUI(); setStatus('idle');
  }

  function saveRun(){
    if(!window._lastRun){ alert('Tidak ada run untuk disimpan'); return; }
    const last = JSON.parse(JSON.stringify(window._lastRun));
    // attach dyno info if available
    const dynoHp = parseFloat(localStorage.getItem('dyno_hp'));
    if(dynoHp) last.dynoHP = dynoHp;
    history.unshift(last);
    localStorage.setItem('rb_history', JSON.stringify(history));
    renderHistory();
    alert('Run disimpan.');
  }

  function exportCSV(){
    if(history.length === 0){ alert('History kosong'); return; }
    const rows = [['d20_s','d100_s','d201_s','d402_s','s20_kmh','s100_kmh','s201_kmh','s402_kmh','peak_kmh','peak_g','rollout','date']];
    history.forEach(h=>{
      rows.push([
        h.d20 ? h.d20.toFixed(3) : '',
        h.d100 ? h.d100.toFixed(3) : '',
        h.d201 ? h.d201.toFixed(3) : '',
        h.d402 ? h.d402.toFixed(3) : '',
        h.s20 ? h.s20.toFixed(2) : '',
        h.s100 ? h.s100.toFixed(2) : '',
        h.s201 ? h.s201.toFixed(2) : '',
        h.s402 ? h.s402.toFixed(2) : '',
        h.peak ? h.peak.toFixed(2) : '',
        h.peakG ? h.peakG.toFixed(2) : '',
        h.rollout ? 1 : 0,
        new Date(h.date).toISOString()
      ]);
    });
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='racebox_history.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // dyno load/save
  function loadDyno(){
    const hp = localStorage.getItem('dyno_hp');
    const rpm = localStorage.getItem('dyno_rpm');
    if(hp){
      dynoHP.value = hp;
      dynoHP_RPM.value = rpm || '';
      dynoResult.textContent = `Dyno: ${hp} HP @ ${rpm||'—'} RPM`;
    } else {
      dynoResult.textContent = 'Dyno not set';
    }
  }
  function saveDyno(){
    const hp = parseFloat(dynoHP.value);
    const rpm = parseInt(dynoHP_RPM.value);
    if(isNaN(hp)){ alert('Masukkan dyno HP valid'); return; }
    localStorage.setItem('dyno_hp', hp);
    localStorage.setItem('dyno_rpm', rpm || '');
    dynoResult.textContent = `Dyno: ${hp} HP @ ${rpm||'—'} RPM`;
  }
  if(saveDynoBtn) saveDynoBtn.addEventListener('click', saveDyno);
  loadDyno();

  // estimate button
  if(estimateBtn) estimateBtn.addEventListener('click', ()=>{
    const mass = parseFloat(massInput.value || '0');
    const marker = parseInt(estMarker.value || '201', 10);
    if(isNaN(mass) || mass <= 0){ alert('Masukkan mass (kg) valid'); return; }
    const res = estimateWHP(mass, marker);
    if(!res){ estimateResult.textContent='Marker data belum tersedia. Jalankan 1 run.'; return; }
    estimateResult.innerHTML = `Estimate WHP: <strong>${res.hp.toFixed(2)} HP</strong> — avg ${(res.powerW/1000).toFixed(2)} kW (v=${res.v.toFixed(2)} m/s, t=${res.t.toFixed(3)} s)`;
  });

  // bindings
  if(armBtn) armBtn.addEventListener('click', arm);
  if(stopBtn) stopBtn.addEventListener('click', stop);
  if(resetBtn) resetBtn.addEventListener('click', resetAll);
  if(saveBtn) saveBtn.addEventListener('click', saveRun);
  if(exportBtn) exportBtn.addEventListener('click', exportCSV);

  // init UI
  resetMarks();
  renderHistory();
  resetUI();
  setStatus('idle');

  // expose debug
  window.RaceBox = {
    state: ()=>({armed,running,finished,cumulative,peakSpeed,marks,history}),
    lastRun: ()=>window._lastRun || null,
    estimateWHP
  };

  if('serviceWorker' in navigator){
    try{ navigator.serviceWorker.register('sw.js').catch(()=>{}); }catch(e){}
  }
})();
</script>
</body>
</html>
